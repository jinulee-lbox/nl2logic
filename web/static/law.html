<!DOCTYPE html>
<html>
<head>
    <title>Lâ´ Annotator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            font-size: 13px;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        table {
            width: 100%;
            table-layout: fixed;
            text-align: left;
            vertical-align: middle;
        }

        .nl-asp-term {
            display: flex;
            align-items: center;
        }
        .conclusion {
            display: flex;
            align-items: center;
        }

        .asp-term input {
            margin-right: 10px;
            width: 97%;
        }
        .asp-conc input {
            margin-right: 10px;
            width: 97%;
        }
        .delete-parent {
            cursor: pointer;
        }

        #term-container {
            margin-top: 20px;
        }
        #conc-container {
            margin-top: 20px;
        }

        #add-term-btn {
            margin-top: 10px;
            cursor: pointer;
        }
        #add-conc-btn {
            margin-top: 10px;
            cursor: pointer;
        }

        #submit-btn {
            margin-top: 20px;
            cursor: pointer;
        }

        .msgbox {
            margin: 10px;
            padding: 10px;
            border: 1px solid black;
            font-family: monospace;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1> Lâ´(LBox Legal Logic Language) Annotator : ë²•ë ¹</h1>
    <a href="/case.html">íŒë¡€ íƒœê¹…í•˜ê¸°</a> | <a href="/sandbox.html">ììœ  í¸ì§‘í•˜ê¸°</a>
    <h3>ë²•ë ¹ ì •ë³´</h3>
    <label for="lawname">ë²•ë ¹ëª… (ë„ì–´ì“°ê¸° ì—†ì´ - í˜•ì‚¬ì¼ë°˜, ë„ë¡œêµí†µë²•ìœ„ë°˜(ìŒì£¼ìš´ì „), ...)</label>
    <input type="text" id="lawname">
    <button id="load-case-form-btn">ë²•ë ¹ ë¶ˆëŸ¬ì˜¤ê¸°</button>

    <hr>

    <div id="term-container">
        <h3>ê·œì¹™</h3>
        ASP termì€ ë§ˆì¹¨í‘œë¡œ ëë‚˜ì•¼ í•¨<br>
        - ì„¤ëª…ì€ ë²•ë ¹ ì›ë¬¸/ëŒ€ë²•ì› íŒë¡€ì™€ ìµœëŒ€í•œ ê°™ì€ ë‹¨ì–´ë¡œ, <br>
        - ì™„ê²°ëœ ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±<br>
        <br>
        <table class='asp-term-table' id='asp-term-table'>
        </table>
    </div>
    <button id="add-term-btn">ASP ì¶”ê°€...</button><br>

    <hr>

    <button id="submit-btn">DBì— ë“±ë¡í•˜ê¸°</button>
    <button id="reset-btn">í™”ë©´ ì´ˆê¸°í™”</button>
    <!-- <br> -->
    <!-- <b>ê²½ê³ : DBì— ë“±ë¡í•˜ê¸° ë²„íŠ¼ì€ í•´ë‹¹ íŒë¡€ ë²ˆí˜¸ì— ì €ì¥ëœ ë‚´ìš©ì„ ë®ì–´ì”Œì›ë‹ˆë‹¤.</b> -->
    <div id="log-msg" class="msgbox"></div>

    <script>
        // up-to-date `delete-parent` button event handlers
        function updateDeleteParentEventHandler() {
            const deleteButtons = document.getElementsByClassName('delete-parent');

            Array.from(deleteButtons).forEach( button => {
                // add the event listener to each button
                if (button.getAttribute('listener') !== 'true') {
                    button.addEventListener('click', () => {
                            button.closest('.element').remove()
                    }); 
                    button.setAttribute('listener', 'true');
                }
            });
        }
        // Function to add another aligned term of text inputs
        function addTerm() {
            const termContainer = document.getElementById('asp-term-table');
            const alignedTerm = document.createElement('tr');
            alignedTerm.classList.add('asp-term');
            alignedTerm.classList.add('element');
            alignedTerm.innerHTML = `
                <td class="delete-parent" width="15px">âœ–ï¸</td>
                <td width="15px">
                    <div class="move-up">ğŸ”¼</div>
                    <div class="move-down">ğŸ”½</div>
                </td>
                <td>
                    <input type="text" class="term-comment" placeholder="ìì—°ì–´ ì„¤ëª…"><br>
                    <input type="text" class="term-input" placeholder="ì‚¬ì‹¤/ê·œì¹™(ASP)">
                </td>
                <td width="50px">
                    <select name="source" class="term-source">
                        <option value="law">ë²•ë¦¬</option>
                    </select>
                    <span class="term-msg"></span>
                </td>
            `;
            termContainer.appendChild(alignedTerm);
            updateDeleteParentEventHandler();
        }
        function resetScreen() {
            // Reset number/input value of terms/concs
            const termInputs = document.getElementsByClassName('asp-term');
            Array.from(termInputs).forEach((e) => e.remove());
            addTerm();

            // Clean log outputs
            const termMsg = document.getElementsByClassName('term-msg');
            for (let i = 0; i < termMsg.length; i++) {
                termMsg[i].textContent = "";
            }
            const logContainer = document.getElementById('log-msg');
            logContainer.innerHTML = "";
        }

        // Function to handle form submission
        function parseData() {
            const lawName = document.getElementById('lawname').value;
            const terms = [];

            const termInputs = document.getElementsByClassName('term-input');
            const termComments = document.getElementsByClassName('term-comment');
            const termSources = document.getElementsByClassName('term-source');
            for (var i =0; i < termInputs.length; i++) {
                terms.push({
                    asp: termInputs[i].value,
                    comment: termComments[i].value,
                    source: termSources[i].value
                });
            }
            return {
                lawname: lawName,
                terms: terms
            };
        }

        async function updateLogScreen(response) {
            if (response.ok) {
                const responseData = await response.json();
                // Process the response data if needed
                // add message to term-input form
                const termMsg = document.getElementsByClassName('term-msg');
                for (let i = 0; i < termMsg.length; i++) {
                    switch(responseData["program_parse_success"][i]['code']) {
                        case 0: msg = 'âœ…'; break;
                        default: msg = 'âŒ ' + responseData["program_parse_success"][i]['msg']; break;
                    }
                    termMsg[i].textContent = msg;
                }
                // create log message
                aspResult = responseData['asp_result'];
                let logMsg = '';
                logMsg += '<br> ----- Validity check ----- <br>'
                logMsg += 'í…ŒìŠ¤íŠ¸ í†µê³¼ ì—¬ë¶€: ' + (responseData['validity'] == 0? "âœ…" : "âŒ") + "<br>"
                for(const message of responseData['validity_message']) {
                    logMsg += 'âŒ ' + message + '<br>'
                }
                logMsg += '<br> ----- DB update ----- <br>'
                for(const message of responseData['database_message']) {
                    logMsg += '- ' + message + '<br>'
                }
                const logContainer = document.getElementById('log-msg');
                logContainer.innerHTML = logMsg;
            } else {
                console.error('Error:', response.status);
            }
        }

        async function handleUpdateDB() {
            data = parseData()
            try {
                const response = await fetch('/update_law_db', {
                    method: 'POST',
                    headers: {
                    'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                await updateLogScreen(response)
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadLawData() {
            data = parseData()
            law_id = data['lawname']
            try {
                const response = await fetch('/get_law_form?' + new URLSearchParams({
                    law_id: law_id,
                }));
                data = await response.json();
                if(Object.keys(data).length === 0) {
                    alert("ë²•ë ¹ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    return;
                }
                // reset screen
                resetScreen();

                // law info
                document.getElementById('lawname').value = data["lawname"];

                // term - add appropriate number of textboxes
                term_len = data['terms'].length;
                while(document.getElementsByClassName('term-input').length < term_len) {
                    addTerm();
                }
                // term - update contents
                const termInputs = document.getElementsByClassName('term-input');
                const termComments = document.getElementsByClassName('term-comment');
                const termSources = document.getElementsByClassName('term-source');
                for (var i = 0; i < term_len; i++) {
                    term = data['terms'][i];
                    termInputs[i].value = term['asp'];
                    termComments[i].value = term['comment'];
                    termSources[i].value = term['source'];
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Add event listeners to buttons
        document.getElementById('load-case-form-btn').addEventListener('click', loadLawData);
        document.getElementById('add-term-btn').addEventListener('click', addTerm);
        document.getElementById('submit-btn').addEventListener('click', handleUpdateDB);
        document.getElementById('reset-btn').addEventListener('click', resetScreen);
        document.addEventListener("DOMContentLoaded", function() {
            // Up/down button            
            Array.from(document.getElementsByTagName("table")).forEach( table => {
                table.addEventListener("click", function(event) {
                    const target = event.target;
                    const row = target.closest("tr");
                    console.log(row)
                    
                    if (target.classList.contains("move-up")) {
                        if (row && row.previousElementSibling) {
                            table.insertBefore(row, row.previousElementSibling);
                        }
                    } else if (target.classList.contains("move-down")) {
                        if (row && row.nextElementSibling) {
                            table.insertBefore(row.nextElementSibling, row);
                        }
                    }
                });
            });
        });
        addTerm();
    </script>
</body>
</html>
